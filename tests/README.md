# Visual Piano Component Testing

This directory contains comprehensive tests for the Visual Piano component, including visual regression testing and component functionality validation.

## Test Structure

### Main Test Files

- **`visual-piano.spec.ts`** - Main comprehensive test suite for the Visual Piano component
  - Component structure validation (key counts, layout)
  - Visual regression testing with screenshots
  - Color highlighting functionality
  - Theme switching (light/dark)
  - Different octave configurations
  - Interactive behavior testing

### Debug Files ~~(Removed)~~

- ~~**`debug/`** - Directory was cleaned up after development completion~~
  - ~~Debug files were temporary and removed to keep the project clean~~

### Screenshots & Reports

- **`screenshots/`** - Directory containing generated screenshot files
  - Visual regression testing baseline images
  - Debug screenshots from development process
  - All PNG files are automatically organized here
- **`playwright-report/`** - HTML test reports (generated by Playwright)
- **`test-results/`** - Raw test results and artifacts
- **`reports/`** - Custom HTML reports (configured output location)

## Test Categories

### 1. Structure & Layout Tests

- Verify correct number of white keys (7 per octave)
- Verify correct number of black keys (5 per octave)
- Test responsive behavior across different screen sizes
- Validate proper key positioning and alignment

### 2. Visual Regression Tests

- Screenshot comparison for different component states
- Theme variations (light/dark)
- Different octave configurations (1, 2, 3, 4, 7)
- Highlighted note states
- Active note states

### 3. Color System Tests

- PRD-specified color mapping validation
- Note highlighting functionality
- Active state visual feedback
- Color mode switching (per-note vs mono)

### 4. Interactive Behavior Tests

- Mouse click interactions
- Keyboard navigation
- Touch interactions (mobile)
- Event emission validation (noteOn/noteOff)

### 5. Responsive & Accessibility Tests

- Different viewport sizes
- Mobile device compatibility
- Keyboard navigation
- Focus management
- Screen reader compatibility

## Running Tests

### All Tests

```bash
pnpm exec playwright test
```

### Specific Test File

```bash
pnpm exec playwright test tests/visual-piano.spec.ts
```

### Visual Mode (with UI)

```bash
pnpm exec playwright test --ui
```

### Debug Mode

```bash
pnpm exec playwright test --debug
```

### Update Screenshots

```bash
pnpm exec playwright test --update-snapshots
```

## Test Environment

### Prerequisites

- Storybook running on http://localhost:6008
- Playwright browsers installed
- Component stories properly configured

### Browser Testing

- **Primary**: Chromium (consistent rendering)
- **Coverage**: Desktop Chrome simulation
- **Future**: Mobile Safari, Firefox (can be enabled)

## Visual Regression Testing

The test suite uses Playwright's screenshot comparison to detect visual changes:

1. **Baseline Screenshots** - Stored in `test-results/` after first run
2. **Comparison** - New screenshots compared against baselines
3. **Failure Handling** - Visual diffs highlighted when tests fail
4. **Update Process** - Use `--update-snapshots` to accept new visuals

## Key Test Scenarios

### Bug Prevention Tests

These tests specifically prevent regressions of issues that were previously fixed:

1. **Black Key Alignment** - Ensures C# is between C and D, not D and E
2. **Edge Key Visibility** - Verifies first and last keys are fully visible
3. **Color Override System** - Confirms highlighting works without affecting default colors
4. **Responsive Positioning** - Validates alignment during window resize
5. **Multi-octave Layout** - Tests proper key generation across all octaves

### Component States Tested

- Default state (2 octaves, light theme)
- Single octave configuration
- Maximum octaves (7)
- Dark theme
- No labels vs letter labels vs do-re-mi labels
- Highlighted notes (various combinations)
- Active notes (pressed states)
- Disabled state
- Different color modes

## Maintenance

### Adding New Tests

1. Create test in `visual-piano.spec.ts`
2. Use descriptive test names
3. Include screenshot validation for visual features
4. Add comments explaining test purpose

### Screenshot Management

- Screenshots automatically saved to `screenshots/` directory
- Clean up old/unused screenshots periodically
- Update baselines when intentional visual changes are made

### Debug Workflow

1. Add temporary debug tests to `debug/` directory
2. Use console logging and screenshots for investigation
3. Clean up debug files after issues are resolved

## Integration with Storybook

Tests rely on Storybook stories for component isolation:

- Each major component variant has a dedicated story
- Stories provide controlled component states for testing
- Test navigation uses story names for consistency
- Stories serve as living documentation for tested scenarios
